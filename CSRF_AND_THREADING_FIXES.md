# CSRF Token and Threading Fixes

## Summary
Fixed two critical issues preventing the Telegram Automation application from running properly:

1. **CSRF Token Rendering Issue** - Forms were returning 400 errors due to missing CSRF tokens
2. **Signal Handler Threading Error** - Application couldn't start due to signal handler registration in background thread

## Issue 1: CSRF Token Rendering

### Problem
- Form submissions to `/admin/instructions` were returning 400 errors
- Error message: "CSRF token is missing"
- Flask-WTF's CSRF protection was rejecting all POST requests

### Root Cause
- Flask-WTF provides `csrf_token()` function to templates through a context processor
- However, if session cookie is not properly configured or context processor timing issues occur, token might not be available
- The template had `{{ csrf_token() }}` but the function wasn't being executed or returned an empty value

### Solution
Added explicit context processor to `app/__init__.py`:

```python
from flask_wtf.csrf import generate_csrf

@app.context_processor
def inject_csrf_token():
    return dict(csrf_token=generate_csrf)
```

This ensures that:
- The `csrf_token` function is always available in template context
- `generate_csrf` is called inside the request context, ensuring proper session handling
- Templates can use `{{ csrf_token() }}` to get a valid token
- The token is properly included in form submissions

### Changes Made
- **File**: `app/__init__.py`
- **Change**: Added explicit context processor after `csrf.init_app(app)`

### Testing
Created `test_csrf_fix.py` which verifies:
- Login form renders with valid CSRF token ✓
- Login submission with CSRF token succeeds ✓
- Instructions page renders with CSRF tokens ✓
- Form submission with CSRF token is accepted without 400 error ✓

**Result**: ✓ All CSRF token tests PASSED

---

## Issue 2: Signal Handler Threading Error

### Problem
- Application startup failed with: "ValueError: signal only works in main thread of the main interpreter"
- Error occurred when Telethon worker tried to register signal handlers
- Prevented both Flask and Telethon from starting together

### Root Cause
- Python's `signal` module can only register signal handlers in the main thread
- When `run.py` launched Telethon in a background thread, the telethon_runner.py code tried to register signal handlers
- This violated Python's signal handling restrictions and caused the application to crash

### Solution
Modified `telethon_runner.py` to check if running in main thread before registering signal handlers:

```python
import threading

# Only register signal handlers if running in main thread
# (signal handlers cannot be registered from background threads)
if threading.current_thread() is threading.main_thread():
    signal.signal(signal.SIGTERM, handle_shutdown)
    signal.signal(signal.SIGINT, handle_shutdown)
    logger.info('Signal handlers registered')
else:
    logger.info('Running in background thread - signal handlers managed by run.py')
```

This design:
- Signal handlers are managed by `run.py` in the main thread
- Telethon worker thread doesn't attempt to register signal handlers
- Graceful shutdown still works through run.py's handler
- Both threads can start and run concurrently without conflicts

### Changes Made
- **File**: `telethon_runner.py`
- **Lines**: ~170-180
- **Change**: Wrapped signal handler registration in `if threading.current_thread() is threading.main_thread():` check

### Testing
- `python run.py --check` now completes without errors ✓
- Application no longer crashes with threading error ✓
- Flask and Telethon can both be started together ✓

---

## Test Scripts Added

### test_csrf_fix.py
Comprehensive test of CSRF token functionality:
- Tests login with CSRF token extraction from form
- Tests instructions page access with valid session
- Tests form submission with extracted CSRF token
- Verifies no 400 errors are returned

**Result**: ✓ CSRF TOKEN FIX TEST PASSED

### debug_csrf.py
Debug script to analyze CSRF token rendering:
- Shows what's in the HTML response
- Extracts CSRF token values
- Helps diagnose token rendering issues
- Useful for future troubleshooting

---

## How These Fixes Work Together

1. **Before Changes**:
   - User navigates to `/admin/instructions`
   - Page loads but CSRF token is empty or missing
   - User submits form
   - Flask-WTF validation fails because no valid token
   - Server returns 400 error
   - Application can't start because of threading error

2. **After Changes**:
   - User navigates to `/admin/instructions`
   - Page loads with proper CSRF token generated by `generate_csrf` in context processor
   - User submits form with valid token
   - Flask-WTF validation passes
   - Form data is processed successfully (200 OK)
   - Application starts Flask in main thread and Telethon in background thread without signal handler conflicts

---

## Deployment Considerations

### Development
- Ensure `SECRET_KEY` is set in `.env` or environment variable
- CSRF protection is automatic with `CSRFProtect`
- Run with `python run.py` for local development

### Production (Render.com)
- Use separate services in `render.yaml` (already configured)
- Flask service handles web requests (signal handlers in main thread)
- Worker service handles Telethon (signal handlers not registered)
- Database file is shared between services via persistent disk

---

## Files Modified

| File | Changes | Reason |
|------|---------|--------|
| `app/__init__.py` | Added context processor with `generate_csrf` | Ensure CSRF tokens render in all templates |
| `telethon_runner.py` | Added threading check before signal registration | Prevent signal handler errors in background thread |
| `test_csrf_fix.py` | Created (New) | Test CSRF token functionality |
| `debug_csrf.py` | Created (New) | Debug CSRF token rendering |

---

## Verification Steps

To verify these fixes are working:

```bash
# 1. Check dependencies and database
python run.py --check

# 2. Run CSRF token tests
python test_csrf_fix.py

# 3. Start the full application
python run.py
# You should see:
# ✓ APPLICATION STARTED
# - No signal handler errors
# - Both Flask and Telethon running

# 4. Access the web interface
# Browser: http://localhost:5000/admin
# - Login works with CSRF token
# - Instructions form submits without 400 errors
```

---

## Related Issues Fixed

- ✅ Forms returning 400 CSRF validation errors
- ✅ Application crashing on startup due to signal handler threading error
- ✅ Instructions page not saving due to CSRF token validation
- ✅ Unable to run Flask and Telethon together due to threading conflicts

---

## Future Improvements

1. Add CSRF token refresh mechanism for long-lived sessions
2. Implement rate limiting on form submissions
3. Add audit logging for all CSRF validation attempts
4. Consider implementing double-submit cookie pattern as additional security layer
5. Add monitoring for failed CSRF validations in production

---

**Last Updated**: February 18, 2026
**Status**: ✓ PRODUCTION READY
